<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>缓存列表页面(废弃)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="pragma" content="no-cache"/>
    <meta http-equiv="cache-control" content="no-cache"/>
	<link rel="stylesheet" href="http://simp.admin.cnsuning.com/simpbe-admin/resources/css/reset.css" />
	<link rel="stylesheet" href="http://simp.admin.cnsuning.com/simpbe-admin/resources/css/base.css" />
	<link rel="stylesheet" href="http://simp.admin.cnsuning.com/simpbe-admin/resources/css/main.css" />
	
	<script type="text/javascript" src="http://simp.admin.cnsuning.com/simpbe-admin/resources/js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="http://simp.admin.cnsuning.com/simpbe-admin/resources/js/main.js"></script>
	<script type="text/javascript" src="http://simp.admin.cnsuning.com/simpbe-admin/resources/js/utils.js"></script>

	<link rel="stylesheet" href="http://simp.admin.cnsuning.com/simpbe-admin/resources/css/metro-gray/easyui.css" />
	<style type="text/css">
		.p-container .container{font-size:12px;}
		.key{width:100px;display:inline-blick;font-family:Courier New;font-size:12px;padding:0 5px;}
		table{border-collapse:collapse;}
		table td{border:1px solid gray;word-break:break-all; padding:5px 0 }
		table td a{font-size:12px;margin:0px 5px;}
		table td:nth-child(2n-1){background:#fafafa;cursor:default;}
		table td:nth-child(2n-1):hover{background:#e7f4fb;}
		.accordion .accordion-header-selected{background:#30bfb3}
	</style>
</head>
<body>

<div fit="true" class="easyui-panel" border="false"  >
	
	<div id="tt"  fit="true"  style="width:100%;height:100%;">
		
	</div>
	
	<div id="dd"></div>
</div>

<script type="text/javascript" src="http://simp.admin.cnsuning.com/simpbe-admin/resources/js/jquery.easyui.min.js"></script>
<script type="text/javascript">

$(document).ready(function(){
	
	queryPageData()
})

var queryPageData = function(){
	$.ajax({
   		url:"../cache/queryCacheList.do",
   		dataType:"json",
   		success:function(data){
   			buildPage(data);
   			
   			$('#tt').tabs({    
			    border:false,    
			    fit:true,
			    tabPosition:'bottom'  
			});
    	}
   	});
}

function buildPage(data){
	var stringList = data.stringList;
	var listList = data.listList;
	var setList = data.setList;
	var zsetList = data.zsetList;
	var hashList = data.hashList;
	
	doBuild(stringList,'String');
	doBuild(hashList,'Hash');
	doBuild(listList,'List');
	doBuild(setList,'Set');
	doBuild(zsetList,'ZSet');
	
}

function doBuild(list,type){
	var html = '<div title="'+type+'" class="scrollbar" style="overflow:auto;padding:10px;">\
			<div class="p-container" style="margin:0px;">\
				<div class="navigation">\
					<span>首页</span> <i>&gt;</i> <span>缓存管理</span>\
				</div>\
				<div class="container">';
	if(list.length > 0){
		html += '<table cellpadding="0" cellspacing="0">';
		for(var i=0;i<list.length;i++){
			if(i%3==0){
				html += '<tr>'
			}
			var key = list[i];
			html += '<td width="250">\
				<span class="key">'+key + ((key=='mylist')?' (小心，会卡死的)':'') + '</span>\
			</td>\
			<td width="100" align="center">\
				<a href="javascript:void(0);" onclick="showDetailByKey(\''+key+'\')">查看</a>\
				<a href="javascript:void(0);" onclick="clearCacheByKey(\''+key+'\',this)">删除</a>\
			</td>';
			if(i%3==2){
				html += '</tr>'
			}
		}
		html += '</table>'
	}else{
		html += '暂无内容';
	}
	html +='</div></div></div>';
	
	$(html).appendTo('#tt')
}



function showDetailByKey(key){
	$('#dd').dialog({    
	    title: '缓存详情',    
	    width: 850,    
	    height: 500,    
	    closed: false,    
	    cache: false,    
	    href: 'cacheDetail.html',    
	    modal: true   ,
	    onLoad:function(){
	    	queryDetailInfo(key);
	    }
	});
}
function clearCacheByKey(key,obj){
	$.messager.confirm('提醒', 
		'确定删除所选的缓存?', function (r) {
		if(!r){
			return;
		}
		$.ajax({
	        url: '../cache/clearCacheByKey.do?key='+key,
	        dataType:'json'
	    }).done(function (data) {
	    	var result = data.result;
	    	if(result > 0){
	    		$.messager.show({title: "提示", msg: '缓存删除成功', timeout: 1500});
	    	}else{
	    		$.messager.show({title: "提示", msg: 'key不存在或已过期了', timeout: 1500});
	    	}
	    	$(obj).parent().html('').prev().html('<span class="key" style="color:red;">已删除</span>');
	    });
	});
}
function clearHashByKeyAndField(key,field,obj){
	$.messager.confirm('提醒', 
		'确定删除所选的缓存?', function (r) {
		if(!r){
			return;
		}
		$.ajax({
	        url: '../cache/clearHashByKeyAndField.do?key='+key+'&field='+field,
	        dataType:'json'
	    }).done(function (data) {
	    	var result = data.result;
	    	if(result > 0){
	    		$.messager.show({title: "提示", msg: '缓存删除成功', timeout: 1500});
	    	}else{
	    		$.messager.show({title: "提示", msg: 'key,field不存在或已过期了', timeout: 1500});
	    	}
	    	$(obj).parents('tr').remove();
	    });
    });
}





		
		function queryDetailInfo(key){
			$.ajax({
		   		url:"../cache/queryCacheDetailByKey.do?key="+key,
		   		dataType:"json",
		   		success:function(data){
		   			buildDetailPage(data);
		    	}
		   	});
		}
		function buildDetailPage(data){
			var error = data.error;
			if(error){
				$('<span style="color:red">'+error+'</span>').appendTo('.detail_key');
				return;
			}
			var type = data.type;
			var key = data.key;
			var leftTime = data.leftTime;
			var html = '';
			if(type == 'string'){
				var cache = data.cache;
				html = createStringItem(key,leftTime,cache);
			}else if(type =='hash'){
				var cacheList = data.cacheList;
				html = createHashItem(key,leftTime,cacheList);
			}else{
				var values = data.value;
				html = createOtherItem(key,leftTime,values);
			}
			$(html).appendTo('.detail_key')
		}
		
		function createStringItem(key,leftTime,cache){
			var html = '<table style="width:100%;">\
				<tr>\
					<td style="width:250px;padding-left:10px;font-weight:bold;">key</td>\
					<td style="padding-left:10px;font-weight:bold;">value</td>\
					<td style="width:150px;padding-left:10px;font-weight:bold;">expire</td>\
				</tr>\
				<tr>\
					<td style="padding-left:10px;color:#0081C2;">'+key+'</td>\
					<td style="padding-left:10px;color:#15A230;">'+cache.value+'</td>\
					<td style="padding-left:10px;color:#ff0000;">'+leftTime+'s</td>\
				</tr>\
			</table>';
			return html;
		}
		
		function createHashItem(key,leftTime,caches){
			var html = '<table style="width:100%;">\
				<tr>\
					<td colspan="4" style="color:#ff5500;font-size:14px;" align="center"><b>'+key+'</b></td>\
				</tr>\
				<tr>\
					<td style="width:150px;padding-left:10;font-weight:bold;" >field</td>\
					<td style="padding-left:10px;font-weight:bo;">value</td>\
					<td style="width:60px;padding-left:10px;font-weight:bold;">expire</td>\
					<td style="width:90px;padding-left:10px;font-weight:bold;">操作</td>\
				</tr>';
			for(var i=0;i<caches.length;i++){
				var cache = caches[i];
				html += '<tr>\
					<td style="padding-left:10px;color:#0081C2;">'+cache.field+'</td>\
					<td style="padding-left:10px;color:#0081C2;">'+cache.value+'</td>\
					<td style="padding-left:10px;color:#ff0000;">'+leftTime+'s</td>\
					<td style="padding-left:10px;color:#0081C2;">\
						<a href="javascript:void(0);" onclick="clearHashByKeyAndField(\''+key+'\',\''+cache.field+'\',this)">删除</a>\
					</td>\
				</tr>';
			}	
			html +='</table>';
			return html;
		}
		
		function createOtherItem(key,leftTime,values){
			var html = '<table style="width:100%;">\
				<tr>\
					<td colspan="3" style="color:#ff5500;font-size:14px;" align="center"><b>'+key+'</b></td>\
				</tr>\
				<tr>\
					<td style="width:50px;padding-left:10px;font-weight:bold;">序号</td>\
					<td style="padding-left:10px;font-weight:bold;">value</td>\
					<td style="width:150px;padding-left:10px;font-weight:bold;">expire</td>\
				</tr>';
			for(var i=0;i<values.length;i++){
				var v = values[i];
				html += '<tr>\
					<td style="padding-left:10px;color:#0081C2;">'+(i+1)+'</td>\
					<td style="padding-left:10px;color:#15A230;">'+v+'</td>\
					<td style="padding-left:10px;color:#ff0000;">'+leftTime+'s</td>\
				</tr>';
			}
			return html;
		}
</script>

</body>
</html>