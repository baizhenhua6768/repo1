<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>自定义查询页面</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="pragma" content="no-cache"/>
    <meta http-equiv="cache-control" content="no-cache"/>
	<link rel="stylesheet" href="http://simp.admin.cnsuning.com/simpbe-admin/resources/css/reset.css" />
	<link rel="stylesheet" href="http://simp.admin.cnsuning.com/simpbe-admin/resources/css/base.css" />
	<link rel="stylesheet" href="http://simp.admin.cnsuning.com/simpbe-admin/resources/css/main.css" />
	
	<script type="text/javascript" src="http://simp.admin.cnsuning.com/simpbe-admin/resources/js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="http://simp.admin.cnsuning.com/simpbe-admin/resources/js/main.js"></script>
	<script type="text/javascript" src="http://simp.admin.cnsuning.com/simpbe-admin/resources/js/utils.js"></script>

	<link rel="stylesheet" href="http://simp.admin.cnsuning.com/simpbe-admin/resources/css/metro-gray/easyui.css" />
	
		<style type="text/css">
			.ipt{width:80%;}
			.data-list{overflow-x:auto;}
			.data-list table td{width:120px;}
		</style>
	</head>
	<body>
	    <div class="p-container">
            <div class="navigation">
                <span>首页</span>
                <i>&gt;</i>
                <span>系统管理</span>
                <i>&gt;</i>
                <span>自定义查询</span>
            </div>
            <div class="container search">
            	<div class="s-item" id="ds">
		            <span class="param"><label class="required">*</label>数据源: </span>
		            <div class="s-cnt sel-box selectlist">
		                <div class="sel-name">datasource</div>
		                <div class="iconsprite ipt-arrow"></div>
		                <div class="opt-box">
		                    <ul>
	                    		<li value="ssipjndi" class="sel" >假模假样写在这里，显示很NB</li>
		                    </ul>
		                </div>
		                <input class="option" type="hidden" value="ssipjndi" onchange="changeDs"/>
		            </div>
		        </div>
                <div class="s-item last-item" id="table">
		            <span class="param"><label class="required">*</label>表格: </span>
		            <div class="s-cnt sel-box selectlist">
		                <div class="sel-name"></div>
		                <div class="iconsprite ipt-arrow"></div>
		                <div class="opt-box" style="max-height:300px">
		                    <ul id="tables">
		                    	
		                    </ul>
		                </div>
		                <input class="option" type="hidden" onchange="clearIpt"/>
		            </div>
		        </div>
		        <br/>
		        <div class="s-item" style="">
		        	<span class="param"><label class="required"></label>字段名(field): </span>
		        	<div class="s-cnt">
	                	<input class="ipt" id="field" name="field" style="width:220px"/>
	                </div>
		        </div>
		        
		        <div class="s-item" >
		        	<span class="param"><label class="required"></label>字段值(value): </span>
		        	<div class="s-cnt">
	                	<input class="ipt" id="value" name="value" style="width:220px" />
	                </div>
		        </div>
		        
                <div class="s-btn">
                    <span class="param"></span>
                    <div class="s-cnt">
                        <button class="btn">查询</button>
                    </div>
                </div>
            </div>
            <div class="data-list">
                <table>
                    <thead>
                        <tr id="header">
                        	<td class="disable"></td>
                            <td style="width:50px" class="disable operate-td">操作</td>
                        </tr>
                    </thead>
                </table>
            </div>
		</div>
		
	    <script src="http://simp.admin.cnsuning.com/simpbe-admin/resources/js/datatable/jquery.dataTables.min.js"></script>
	    <script>
	    	
	    	//查询页面需要的初始化数据
	    	var queryPageData = function(tableIdx){
				$.ajax({
			   		url:"../cache/showTablesBySuperAdmin.do?selectIndex="+tableIdx,
			   		dataType:"json",
			   		success:function(data){
			   			if(data && data.success){
			   				buildPage(data.data)
			   			}else{
			   				snPlaza.show({"message":data.errorMsg});
		            		return;
			   			}
			    	}
			   	});
			}
			$(document).ready(function() {
            	queryPageData(0);
            });
	    	
	    	
	    	var buildPage =  function(data){
	    		fillTables(data.tables,data.selectIndex);
	    		fillColumns(data.columns);
	    		
	    		//当前选择的表格
	    		var v = $('#table li.sel').attr('value');
            	$('#table input').val(v);
            	$('#table .sel-name').html(v);
            	
                $('.data-list thead td').each(function(i){
                	columns[i] = {"data":$(this).html()};
                	if(i == 0){
                		columns[i]['width'] = '40px';
                	}
                })
                currentTable = v;
                
                initDataTable ();
	    	}
	    	
	    	var fillTables = function(tables,selectIndex){
	    		var lis = '';
	    		for(var i = 0 ;i<tables.length;i++){
	    			var t = tables[i];
	    			var className = (i == selectIndex) ? 'sel' : '';
	    			lis += '<li value="'+t+'" class="'+className+'">'+t+'</li>';
	    			
	    		}
	    		$('ul#tables').html(lis);
	    	}
	    	var fillColumns  = function(columns){
	    		var tds = '<td class="disable"></td>';
	    		for(var i = 0 ;i<columns.length;i++){
	    			var c = columns[i];
	    			var td = '<td title="'+c+'" >'+c+'</td>';
	    			tds += td;
	    		}
	    		tds+='<td style="width:50px" class="disable operate-td">操作</td>';
	    		$('tr#header').html(tds);
	    	}
	    	
	    	
	    	
	    	
	    	//修改数据的时候，当前的表名，修改的字段名，主键名
	    	var currentTable = '',currentField = '',pk='';
            
            var columns = [];
			function initDataTable (){
				var dTable = $('.data-list table').DataTable({
			        "ajax": {
			        	"url":"queryDataByName.do",
			        	"type": "POST",
			        	"data": function (data) {
					        data.tableName = $('#table input').val();
					        data.ds = $('#ds input').val();
					        data.field = $('#field').val();
					        data.value = $('#value').val();
					    }
			        },
			        "columns": columns,
			        "columnDefs": [{
                        "targets": 0,
                        "className":'disable ',
                        "data": null,
                        render: function(data, type, row,meta){
                        	var start = dTable.page.info().start;
                    		return start+meta.row+1;
                        }
                    },{
                    	"targets": -1,
                        "className":'disable operate-td',
                        "data": null,
                        render: function(data, type, row,meta){
                        	return '<a href="javascript:void(0)" class="del">删除</a>';
                        }
                    }]
			    });
			    dTable.on('draw',function(){
		    		snPlaza.removeLoading();
		    		bindEvent(dTable);
			    });
			    
			    dTable.on('preXhr',function(){
			    	snPlaza.loading('.data-list');
			    });
			}
			
			function changeDs(ds){
				window.location.href = 'showTablesBySuperAdmin.htm?selectIndex=0&ds='+ds;
			}
			var needLocation = false;
	    	function query(){
	    		if(needLocation){
		    		var index = $('#table li.sel').index();
		    		currentTable = $('#table li.sel').attr('value');
		    		
		    		columns = [];
		    		var dTable = $('.data-list table').DataTable();
		    		dTable.off('draw');
		    		dTable.off('preXhr');
		    		dTable.clear();
		    		dTable.destroy();  
	            	dTable = null;
	           		queryPageData(index)
            	}else{
            		$('.data-list table').DataTable().ajax.reload();
            	}
            }

	       var clearIpt = function(){
	       		$('#field').val('');
	       		$('#value').val('');
	       		needLocation = true;
	       }
	       
            //查询、重置 按钮执行的操作
            $(".container.search .btn").on("click",function(){
                query();
            });
			
			
			var changeHtml = function(td){
				var v = $.trim(td.html());
				var inputHtml = '<input value="'+v+'" class="ipt" />';
				td.unbind('dblclick').html('');
				$(inputHtml).appendTo(td).focus().bind('blur',function(){
					updateData(this,td);
				});
			}
			function bindEvent(dtable){
				
				var theadTds = $('.data-list thead td:not(.disable)');
				
				$('.data-list tbody td:not(.disable)').each(function(i){
					$(this).attr('title',$(this).text());
					$(this).unbind('dblclick ').bind('dblclick ',function(){
						currentField = $('.data-list thead td').eq($(this).index()).html();
						changeHtml($(this));
					});
					
					//修改时间类型的展现
					if( $(this).html().length == 13 && Number($(this).html()) > 1000000000000){
						i = i%theadTds.length;
						var theadTd = $(theadTds[i]).text();
						
						if(theadTd.indexOf('time')>=0 || theadTd.indexOf('date')>=0){
							var date = new Date(Number($(this).html())).Format("yyyy-MM-dd hh:mm:ss");
							$(this).html(date)
						}
					}
				});
				
				$('.data-list tbody a.del').unbind('click').bind('click',function(){
					var td = $(this).parent();
					snPlaza.confirm('是否删除此选项，请小心操作！！！',function(){
						snPlaza.confirm('真的真的要删除？不在想一下？删了就真没了，后悔药也不管用！',function(){
							del(td);
						});
					});
				});
			}
			
			function updateData(ipt,td){
				var value = ipt.value;
				td.html(value);
				td.bind('dblclick ',function(){
					changeHtml($(this));
				});
				
				//没做改变，不提交到后台
				if(value == td.attr('title')){
					return;
				}
				
				pk = table_pk[currentTable] || "id";
				if(pk == 'null'){
					return;
				}
				var dTable = $('.data-list table').DataTable();
				var row = dTable.row( td.parent() );
				var d = row.data();
				var pkData = d[pk];
				
				var ajaxData = 'field='+currentField+'&fieldValue='+encodeURIComponent(value)+'&pk='+pk+'&pkValue='+pkData+'&tableName='+currentTable;
				snPlaza.loading();
				$.ajax({
		            url: 'updataByPk.do',
		            type: 'POST',
		            contentType:"application/x-www-form-urlencoded;charset=UTF-8",
		            data: ajaxData,
		            processData: false
		        }).done(function (data) {
		        	if(data && data.success){
		        		snPlaza.show({'message':'修改成功'});
		        		td.attr('title',value);
		        	}else{
		           		snPlaza.show({'message':'修改失败'});
		          	}
		        }).always(function(){
		        	snPlaza.removeLoading();
		        })
			}
			
			function del(td){
				pk = table_pk[currentTable] || "id";
				if(pk == 'null'){
					return;
				}
				var dTable = $('.data-list table').DataTable();
				var row = dTable.row( td.parent() );
				var d = row.data();
			
				var pkData = d[pk];
				
				var ajaxData = 'pk='+pk+'&pkValue='+pkData+'&tableName='+currentTable;
				snPlaza.loading();
				$.ajax({
		            url: 'delByPk.do',
		            type: 'POST',
		            contentType:"application/x-www-form-urlencoded;charset=UTF-8",
		            data: ajaxData,
		            processData: false
		        }).done(function (data) {
		        	if(data && data.success){
		        		snPlaza.show({'message':'删除成功'});
		        		$('.data-list table').DataTable().ajax.reload(null,false);
		        	}else{
		           		snPlaza.show({'message':'修改失败'});
		          	}
		        }).always(function(){
		        	snPlaza.removeLoading();
		        })
			}
			
			var table_pk = {"o2o_labels":"label_code"};

        </script>
	</body>
</html>
